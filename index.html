<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#6366f1">
    <title>Mostafa Recorder - 4K Enhanced</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .pulse-dot {
            animation: pulse-animation 2s infinite;
        }
        @keyframes pulse-animation {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.1); }
            100% { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900 text-white min-h-screen">
    <div class="max-w-4xl mx-auto p-4">
        <div class="text-center mb-8 pt-6">
            <h1 class="text-4xl font-bold mb-2">Mostafa Recorder 4K</h1>
            <p class="text-blue-200">Ø¨Ø±Ù†Ø§Ù…Ø¬ ØªØ³Ø¬ÙŠÙ„ Ø´Ø§Ø´Ø© Ø§Ø­ØªØ±Ø§ÙÙŠ Ø¨Ø¬ÙˆØ¯Ø© ØªØµÙ„ Ø¥Ù„Ù‰ 4K</p>
        </div>
        
        <div class="bg-white/10 backdrop-blur-lg rounded-3xl p-6 mb-6 shadow-2xl">
            <div class="text-center mb-6">
                <div id="timer" class="text-6xl font-mono mb-2 text-purple-200">00:00:00</div>
                <div id="status" class="h-6"></div>
            </div>
            
            <div class="flex justify-center gap-3 mb-6 flex-wrap">
                <button id="startBtn" class="bg-red-500 hover:bg-red-600 px-6 py-3 rounded-full font-bold transition-all">Ø¨Ø¯Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
                <button id="pauseBtn" class="hidden bg-yellow-500 hover:bg-yellow-600 px-6 py-3 rounded-full font-bold transition-all">Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª</button>
                <button id="resumeBtn" class="hidden bg-green-500 hover:bg-green-600 px-6 py-3 rounded-full font-bold transition-all">Ø§Ø³ØªØ¦Ù†Ø§Ù</button>
                <button id="stopBtn" class="hidden bg-red-600 hover:bg-red-700 px-6 py-3 rounded-full font-bold transition-all">Ø¥ÙŠÙ‚Ø§Ù</button>
            </div>
            
            <div class="text-center">
                <button id="settingsBtn" class="bg-white/20 hover:bg-white/30 px-6 py-2 rounded-full transition-all">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
            </div>
            
            <div id="settings" class="hidden mt-6 p-6 bg-white/10 rounded-2xl space-y-4">
                <div>
                    <label class="block mb-2 font-semibold">Ø§Ù„Ø¬ÙˆØ¯Ø©:</label>
                    <select id="quality" class="w-full bg-white/20 rounded-lg p-3 text-white border-0 outline-none">
                        <option value="SD">SD (854x480)</option>
                        <option value="HD">HD (1280x720)</option>
                        <option value="FHD" selected>Full HD (1920x1080)</option>
                        <option value="QHD">2K QHD (2560x1440)</option>
                        <option value="UHD">4K UHD (3840x2160)</option>
                    </select>
                </div>
                <div>
                    <label class="block mb-2 font-semibold">Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¥Ø·Ø§Ø±Ø§Øª:</label>
                    <select id="fps" class="w-full bg-white/20 rounded-lg p-3 text-white border-0 outline-none">
                        <option value="24">24 FPS</option>
                        <option value="30" selected>30 FPS</option>
                        <option value="60">60 FPS</option>
                        <option value="120">120 FPS (Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„Ø¹Ø§Ù„ÙŠØ©)</option>
                    </select>
                </div>
                <div>
                    <label class="block mb-2 font-semibold">Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¨Øª (Bitrate):</label>
                    <select id="bitrate" class="w-full bg-white/20 rounded-lg p-3 text-white border-0 outline-none">
                        <option value="low">Ù…Ù†Ø®ÙØ¶ (2.5 Mbps)</option>
                        <option value="medium">Ù…ØªÙˆØ³Ø· (5 Mbps)</option>
                        <option value="high" selected>Ø¹Ø§Ù„ÙŠ (10 Mbps)</option>
                        <option value="ultra">ÙØ§Ø¦Ù‚ (20 Mbps)</option>
                        <option value="max">Ø£Ù‚ØµÙ‰ (40 Mbps)</option>
                    </select>
                </div>
                <div>
                    <label class="block mb-2 font-semibold">Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø¶ØºØ· (Compression):</label>
                    <select id="compression" class="w-full bg-white/20 rounded-lg p-3 text-white border-0 outline-none">
                        <option value="none">Ø¨Ø¯ÙˆÙ† Ø¶ØºØ· (Ø­Ø¬Ù… ÙƒØ¨ÙŠØ±)</option>
                        <option value="balanced" selected>Ù…ØªÙˆØ§Ø²Ù† (Ø§Ù„Ø£ÙØ¶Ù„)</option>
                        <option value="high">Ø¶ØºØ· Ø¹Ø§Ù„ÙŠ (Ø­Ø¬Ù… ØµØºÙŠØ±)</option>
                    </select>
                </div>
                <div>
                    <label class="block mb-2 font-semibold">Ù…ØµØ¯Ø± Ø§Ù„ØµÙˆØª:</label>
                    <select id="audioSource" class="w-full bg-white/20 rounded-lg p-3 text-white border-0 outline-none">
                        <option value="none">Ø¨Ø¯ÙˆÙ† ØµÙˆØª</option>
                        <option value="mic">Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† ÙÙ‚Ø·</option>
                        <option value="system">ØµÙˆØª Ø§Ù„Ø¬Ù‡Ø§Ø² ÙÙ‚Ø·</option>
                        <option value="both" selected>Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† + ØµÙˆØª Ø§Ù„Ø¬Ù‡Ø§Ø²</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div class="bg-white/10 backdrop-blur-lg rounded-3xl p-6 shadow-2xl">
            <h2 class="text-2xl font-bold mb-4">Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª (<span id="count">0</span>)</h2>
            <div id="recordings" class="space-y-4">
                <div class="text-center py-12 text-blue-200">
                    <p class="text-lg">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ³Ø¬ÙŠÙ„Ø§Øª Ø¨Ø¹Ø¯</p>
                    <p class="text-sm mt-2">Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¢Ù†!</p>
                </div>
            </div>
        </div>
        
        <div class="text-center mt-6 text-blue-200 text-sm pb-6">
            <p>Mostafa Recorder 4K Â© 2024</p>
        </div>
    </div>

    <script>
        var mediaRecorder = null;
        var chunks = [];
        var stream = null;
        var time = 0;
        var timer = null;
        var recs = [];
        var qual = 'FHD';
        var rate = 30;
        var bitrateLevel = 'high';
        var compressionLevel = 'balanced';
        var audioSource = 'both';

        document.getElementById('settingsBtn').onclick = function() {
            var el = document.getElementById('settings');
            if (el.classList.contains('hidden')) {
                el.classList.remove('hidden');
            } else {
                el.classList.add('hidden');
            }
        };

        document.getElementById('quality').onchange = function(e) {
            qual = e.target.value;
        };

        document.getElementById('fps').onchange = function(e) {
            rate = parseInt(e.target.value);
        };

        document.getElementById('bitrate').onchange = function(e) {
            bitrateLevel = e.target.value;
        };

        document.getElementById('compression').onchange = function(e) {
            compressionLevel = e.target.value;
        };

        document.getElementById('audioSource').onchange = function(e) {
            audioSource = e.target.value;
        };

        function fmt(s) {
            var h = Math.floor(s / 3600);
            var m = Math.floor((s % 3600) / 60);
            var sec = s % 60;
            return pad(h) + ':' + pad(m) + ':' + pad(sec);
        }

        function pad(n) {
            return n < 10 ? '0' + n : n;
        }

        function tick() {
            time = time + 1;
            document.getElementById('timer').textContent = fmt(time);
        }

        function getResolution(quality) {
            var resolutions = {
                'SD': { width: 854, height: 480 },
                'HD': { width: 1280, height: 720 },
                'FHD': { width: 1920, height: 1080 },
                'QHD': { width: 2560, height: 1440 },
                'UHD': { width: 3840, height: 2160 }
            };
            return resolutions[quality] || resolutions['FHD'];
        }

        function getBitrate(level) {
            var bitrates = {
                'low': 2500000,
                'medium': 5000000,
                'high': 10000000,
                'ultra': 20000000,
                'max': 40000000
            };
            return bitrates[level] || bitrates['high'];
        }

        function adjustBitrateForCompression(baseBitrate) {
            if (compressionLevel === 'high') {
                return Math.floor(baseBitrate * 0.6);
            } else if (compressionLevel === 'balanced') {
                return Math.floor(baseBitrate * 0.8);
            }
            return baseBitrate;
        }

        function start() {
            var res = getResolution(qual);
            var needSystemAudio = audioSource === 'system' || audioSource === 'both';
            var needMic = audioSource === 'mic' || audioSource === 'both';
            
            navigator.mediaDevices.getDisplayMedia({
                video: {
                    width: { ideal: res.width, max: res.width },
                    height: { ideal: res.height, max: res.height },
                    frameRate: { ideal: rate, max: rate }
                },
                audio: needSystemAudio
            }).then(function(vidStream) {
                if (needMic) {
                    navigator.mediaDevices.getUserMedia({
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            sampleRate: 48000
                        }
                    }).then(function(micStream) {
                        continueStart(vidStream, micStream);
                    }).catch(function() {
                        continueStart(vidStream, null);
                    });
                } else {
                    continueStart(vidStream, null);
                }
            }).catch(function(err) {
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + err.message);
            });
        }

        function continueStart(vidStream, micStream) {
            var tracks = vidStream.getVideoTracks();
            var audioContext = null;
            var destination = null;
            
            if (audioSource !== 'none') {
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    destination = audioContext.createMediaStreamDestination();
                    
                    var systemAudioTracks = vidStream.getAudioTracks();
                    if (systemAudioTracks.length > 0 && (audioSource === 'system' || audioSource === 'both')) {
                        var systemSource = audioContext.createMediaStreamSource(new MediaStream(systemAudioTracks));
                        systemSource.connect(destination);
                    }
                    
                    if (micStream && (audioSource === 'mic' || audioSource === 'both')) {
                        var micSource = audioContext.createMediaStreamSource(micStream);
                        micSource.connect(destination);
                    }
                    
                    var finalAudioTracks = destination.stream.getAudioTracks();
                    for (var i = 0; i < finalAudioTracks.length; i++) {
                        tracks.push(finalAudioTracks[i]);
                    }
                } catch (e) {
                    console.error('Ø®Ø·Ø£ ÙÙŠ Ø¯Ù…Ø¬ Ø§Ù„ØµÙˆØª:', e);
                    var systemAudioTracks = vidStream.getAudioTracks();
                    if (systemAudioTracks.length > 0) {
                        for (var i = 0; i < systemAudioTracks.length; i++) {
                            tracks.push(systemAudioTracks[i]);
                        }
                    }
                    if (micStream) {
                        var micTracks = micStream.getAudioTracks();
                        for (var i = 0; i < micTracks.length; i++) {
                            tracks.push(micTracks[i]);
                        }
                    }
                }
            }
            
            stream = new MediaStream(tracks);
            var baseBits = getBitrate(bitrateLevel);
            var bits = adjustBitrateForCompression(baseBits);
            
            var options = {
                videoBitsPerSecond: bits
            };
            
            var mimeTypes = [
                'video/webm;codecs=vp9',
                'video/webm;codecs=h264',
                'video/webm;codecs=vp8',
                'video/webm'
            ];
            
            for (var i = 0; i < mimeTypes.length; i++) {
                if (MediaRecorder.isTypeSupported(mimeTypes[i])) {
                    options.mimeType = mimeTypes[i];
                    break;
                }
            }
            
            try {
                mediaRecorder = new MediaRecorder(stream, options);
            } catch (e) {
                mediaRecorder = new MediaRecorder(stream);
            }
            
            chunks = [];
            
            mediaRecorder.ondataavailable = function(e) {
                if (e.data.size > 0) {
                    chunks.push(e.data);
                }
            };
            
            mediaRecorder.onstop = function() {
                var blob = new Blob(chunks, {type: 'video/webm'});
                var url = URL.createObjectURL(blob);
                var rec = {
                    id: Date.now(),
                    url: url,
                    dur: time,
                    date: new Date().toLocaleString('ar-EG'),
                    size: (blob.size / (1024 * 1024)).toFixed(2),
                    quality: qual,
                    fps: rate,
                    compression: compressionLevel
                };
                recs.unshift(rec);
                updateList();
                time = 0;
                document.getElementById('timer').textContent = '00:00:00';
                if (stream) {
                    var allTracks = stream.getTracks();
                    for (var i = 0; i < allTracks.length; i++) {
                        allTracks[i].stop();
                    }
                }
            };
            
            mediaRecorder.start(1000);
            document.getElementById('startBtn').classList.add('hidden');
            document.getElementById('pauseBtn').classList.remove('hidden');
            document.getElementById('stopBtn').classList.remove('hidden');
            timer = setInterval(tick, 1000);
            document.getElementById('status').innerHTML = '<div class="flex items-center justify-center gap-2"><div class="w-3 h-3 bg-red-500 rounded-full pulse-dot"></div><span class="text-red-300 font-semibold">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ø¬ÙˆØ¯Ø© ' + qual + ' @ ' + rate + ' FPS</span></div>';
            
            vidStream.getVideoTracks()[0].onended = function() {
                stop();
            };
        }

        function pause() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.pause();
                clearInterval(timer);
                document.getElementById('pauseBtn').classList.add('hidden');
                document.getElementById('resumeBtn').classList.remove('hidden');
                document.getElementById('status').innerHTML = '<span class="text-yellow-300 font-semibold">Ù…ØªÙˆÙ‚Ù Ù…Ø¤Ù‚ØªØ§Ù‹</span>';
            }
        }

        function resume() {
            if (mediaRecorder && mediaRecorder.state === 'paused') {
                mediaRecorder.resume();
                timer = setInterval(tick, 1000);
                document.getElementById('resumeBtn').classList.add('hidden');
                document.getElementById('pauseBtn').classList.remove('hidden');
                document.getElementById('status').innerHTML = '<div class="flex items-center justify-center gap-2"><div class="w-3 h-3 bg-red-500 rounded-full pulse-dot"></div><span class="text-red-300 font-semibold">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</span></div>';
            }
        }

        function stop() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                clearInterval(timer);
                document.getElementById('startBtn').classList.remove('hidden');
                document.getElementById('pauseBtn').classList.add('hidden');
                document.getElementById('resumeBtn').classList.add('hidden');
                document.getElementById('stopBtn').classList.add('hidden');
                document.getElementById('status').innerHTML = '';
            }
        }

        function updateList() {
            document.getElementById('count').textContent = recs.length;
            if (recs.length === 0) {
                document.getElementById('recordings').innerHTML = '<div class="text-center py-12 text-blue-200"><p class="text-lg">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ³Ø¬ÙŠÙ„Ø§Øª Ø¨Ø¹Ø¯</p></div>';
                return;
            }
            var html = '';
            for (var i = 0; i < recs.length; i++) {
                var r = recs[i];
                html += '<div class="bg-white/10 rounded-xl p-4 flex items-center justify-between hover:bg-white/15 transition-all"><div class="flex-1"><div class="font-bold mb-1">ØªØ³Ø¬ÙŠÙ„ ' + r.id + ' <span class="text-xs bg-purple-500 px-2 py-1 rounded">' + r.quality + '</span> <span class="text-xs bg-blue-500 px-2 py-1 rounded">' + r.fps + ' FPS</span></div><div class="text-sm text-blue-200"><span>â±ï¸ ' + fmt(r.dur) + '</span><span class="mr-4">ğŸ“ ' + r.size + ' MB</span><span class="mr-4">ğŸ“… ' + r.date + '</span></div></div><div class="flex gap-2"><button onclick="dl(' + r.id + ')" class="bg-green-500 hover:bg-green-600 p-3 rounded-full transition-all text-xl">ğŸ’¾</button><button onclick="del(' + r.id + ')" class="bg-red-500 hover:bg-red-600 p-3 rounded-full transition-all text-xl">ğŸ—‘ï¸</button></div></div>';
            }
            document.getElementById('recordings').innerHTML = html;
        }

        function dl(id) {
            for (var i = 0; i < recs.length; i++) {
                if (recs[i].id === id) {
                    var a = document.createElement('a');
                    a.href = recs[i].url;
                    a.download = 'Mostafa_Recorder_' + recs[i].quality + '_' + recs[i].fps + 'fps_' + id + '.webm';
                    a.click();
                    break;
                }
            }
        }

        function del(id) {
            var newRecs = [];
            for (var i = 0; i < recs.length; i++) {
                if (recs[i].id !== id) {
                    newRecs.push(recs[i]);
                }
            }
            recs = newRecs;
            updateList();
        }

        document.getElementById('startBtn').onclick = start;
        document.getElementById('pauseBtn').onclick = pause;
        document.getElementById('resumeBtn').onclick = resume;
        document.getElementById('stopBtn').onclick = stop;
    </script>
</body>
</html>
